---
# install-password-pusher and patch

- name: clone the password pusher repository
  git:
    repo: git://github.com/bemosior/PHPasswordPusher.git
    dest: "{{ eqpress_docroot }}/pwpusher"
    recursive: yes
    version: "{{ auto_provision_pwpusher_version }}"
    accept_hostkey: yes
    force: yes
  tags:
    - pwpusher

- name: nginx sites-available for password pusher
  template:
    src: etc/nginx/sites-available/pwpusher.j2
    dest: /etc/nginx/sites-available/pwpusher
    mode: '0644'
    owner: root
    group: root
  tags:
    - pwpusher

- name: copy patch for pwpusher to work with rampress
  copy:
    src: pw_rampress.patch
    dest: "{{eqpress_docroot}}/pwpusher/pw_rampress.patch"
  tags:
    - pwpusher

- name: patch pwpusher 
  shell: "cd {{eqpress_docroot}}/pwpusher && /usr/bin/git checkout -- . && /usr/bin/git apply pw_rampress.patch"
  tags:
    - pwpusher

- name: install pwpusher custom config file
  template:
    src: pwpusher/config.php.j2
    dest: "{{eqpress_docroot}}/pwpusher/pwpusher_private/config.php"
    owner: root
    group: root
    mode: '0644'
  tags:
    - pwpusher

- name: install pwpusher custom install file
  template:
    src: pwpusher/install.php.j2
    dest: "{{eqpress_docroot}}/pwpusher/rp_pwinstall.php"
    owner: root
    group: root
    mode: '0700'
  tags:
    - pwpusher

- name: run pwpusher custom install script
  shell: cd {{eqpress_docroot}}/pwpusher && /usr/bin/php rp_pwinstall.php
  tags:
    - pwpusher

- name: remove some files
  file:
    path: "{{eqpress_docroot}}/pwpusher/{{ item }}"
    state: absent
  loop:
    - install.php
    - rp_pwinstall.php
    - pw_rampress.patch
  tags:
    - pwpusher

- name: link password pusher nginx config 
  file:
    src: /etc/nginx/sites-available/pwpusher
    dest: /etc/nginx/sites-enabled/pwpusher
    state: link
  tags:
    - pwpusher
